<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>ุฅููุงู - ุงููุณุงุนุฏ ุงูุตูุชู ุงูุฐูู</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <div id="robot" class="robot">
      <div class="eyes">
        <div class="eye"></div>
        <div class="eye"></div>
      </div>
      <div class="mouth"></div>
    </div>

    <div id="response-box" class="response-box"></div>

    <button id="toggle-speech" class="control-button">๐ ุชุดุบูู/ุฅููุงู ุงูุตูุช</button>
    <button id="toggle-display" class="control-button">๐ ุฅุธูุงุฑ ุงููุต ุจุฏูุงู ูู ุงููุฌู</button>
    <div id="status" class="status">๐ค ุฌุงุฑู ุงูุชููุฆุฉ...</div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const responseBox = document.getElementById("response-box");
    const robot = document.getElementById("robot");
    const toggleSpeechBtn = document.getElementById("toggle-speech");
    const toggleDisplayBtn = document.getElementById("toggle-display");

    let isListening = false;
    let isSpeechEnabled = true;
    let showTextMode = false;
    let recognition;

    // ๐ ุฅุนุฏุงุฏ ุงูุงุณุชูุงุน ุงูุชููุงุฆู
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.lang = "ar-SA";
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isListening = true;
        statusEl.textContent = "๐ง ุฅููุงู ุชุณุชูุน ุฅููู...";
        document.querySelector(".mouth").style.animation = "speak 0.5s infinite";
      };

      recognition.onend = () => {
        isListening = false;
        statusEl.textContent = "๐ ุฌุงุฑู ุฅุนุงุฏุฉ ุงูุชุดุบูู...";
        document.querySelector(".mouth").style.animation = "";
        recognition.start(); // ุฅุนุงุฏุฉ ุงูุชุดุบูู ุงูุชููุงุฆู
      };

      recognition.onresult = async (event) => {
        const text = event.results[event.results.length - 1][0].transcript;
        statusEl.textContent = "๐ญ ุฌุงุฑู ุงููุนุงูุฌุฉ...";
        const response = await fetch("/process_audio", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });
        const data = await response.json();
        responseBox.textContent = data.reply;
        responseBox.style.display = "block";
        statusEl.textContent = "โ ุงูุฑุฏ ุฌุงูุฒ!";

        if (isSpeechEnabled && !showTextMode) speak(data.reply);
      };

      // ๐ ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ ุชุญููู ุงูุตูุญุฉ
      recognition.start();
    }

    // ๐๏ธ ุฒุฑ ุชุดุบูู/ุฅููุงู ุงูุตูุช
    toggleSpeechBtn.onclick = () => {
      isSpeechEnabled = !isSpeechEnabled;
      toggleSpeechBtn.textContent = isSpeechEnabled ? "๐ ุชุดุบูู/ุฅููุงู ุงูุตูุช" : "๐ ุงูุตูุช ูุชููู";
    };

    // ๐ ุฒุฑ ุชุจุฏูู ุงููุงุฌูุฉ ุจูู ุงููุฌู ูุงููุต
    toggleDisplayBtn.onclick = () => {
      showTextMode = !showTextMode;
      if (showTextMode) {
        robot.style.display = "none";
        responseBox.style.display = "block";
        toggleDisplayBtn.textContent = "๐ค ุฅุธูุงุฑ ุงููุฌู";
      } else {
        robot.style.display = "block";
        toggleDisplayBtn.textContent = "๐ ุฅุธูุงุฑ ุงููุต";
      }
    };

    // ๐ค ูุทู ุงูุตูุช ุจูุจุฑุฉ ูุซุงููุฉ
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ar-SA";
      utterance.rate = 1;
      utterance.pitch = 1.2; // ูุจุฑุฉ ูุซุงููุฉ
      utterance.volume = 1;
      utterance.voice = speechSynthesis.getVoices().find(v => v.name.includes("Microsoft") || v.lang === "ar-SA");
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
